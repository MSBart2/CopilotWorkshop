# ============================================================================
# TECH TALK PIPELINE â€” PHASE 4: SLIDES  (Final Phase)
# ============================================================================
#
# WHAT THIS DOES:
#   Generates a Slidev slide deck (.md) from the finished README.md.
#   Pushes the slides to the existing PR so everything is in one review.
#
# WHEN IT RUNS:
#   When the "tech-talk:slides" label is added to the issue.
#   The user adds this label after reviewing the Phase 3 PR content.
#
# WHAT IT PRODUCES:
#   slides/tech-talks/{topic}.md â€” The Slidev presentation file
#
# WHAT HAPPENS NEXT:
#   All 4 phases are done. A comment tells the user to merge the PR.
#   After merge, the slide deployment workflow publishes to production.
#
# RELATED FILES:
#   Prompt template: .github/prompts/tech-talk/slides-instructions.md
#   Phase 3:         .github/workflows/tech-talk-3-build.yml
#   Slide build:     slides/scripts/build-all.sh
# ============================================================================

name: "Tech Talk Phase 4: Slides"

# Triggers when any label is added to an issue.
# The "if:" guard below filters for the specific label we care about.
on:
  issues:
    types: [labeled]

jobs:
  slides:
    name: Generate Slides
    runs-on: ubuntu-latest

    # Two conditions must BOTH be true:
    #   1. Issue has the "tech-talk" base label
    #   2. Issue has the "tech-talk:slides" phase label
    if: |
      contains(github.event.issue.labels.*.name, 'tech-talk') &&
      contains(github.event.issue.labels.*.name, 'tech-talk:slides')

    permissions:
      issues: write # Post comments and update labels
      contents: write # Push slides to the branch
      pull-requests: write # Update PR (if needed)

    steps:
      # â”€â”€ SETUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history needed to find the feature branch

      # Install Node.js (required by Copilot CLI)
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # Install GitHubâ€™s AI assistant as a CLI tool
      - name: Install GitHub Copilot CLI
        run: npm install -g @github/copilot

      # â”€â”€ EXTRACT ISSUE DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Parse the structured fields from the issue body (filled in by the template)
      - name: Extract issue fields
        id: extract # Outputs: topic, primary_question, audience, section, duration
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || '';

            const extractField = (label) => {
              const regex = new RegExp(`### ${label}\\s*\\n\\s*([^#]+)`, 'i');
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            };

            const topic = extractField('Tech Talk Topic');
            if (!topic) {
              core.setFailed('Could not extract topic from issue');
              return;
            }

            core.setOutput('topic', topic);
            core.setOutput('primary_question', extractField('Primary Question') || 'Not specified');
            core.setOutput('audience', extractField('Target Audience') || 'Mixed Audience');
            core.setOutput('section', extractField('Index Section') || 'Context & Customization');
            core.setOutput('duration', extractField('Expected Duration') || '45 minutes');

      # â”€â”€ CHECKOUT FEATURE BRANCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout feature branch
        id: branch # Outputs: steps.branch.outputs.branch_name
        run: |
          TOPIC="${{ steps.extract.outputs.topic }}"
          BRANCH_NAME="tech-talk/${TOPIC}-${{ github.event.issue.number }}"

          if git ls-remote --exit-code origin "$BRANCH_NAME" > /dev/null 2>&1; then
            git checkout "$BRANCH_NAME"
            echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
            echo "âœ… Checked out branch: $BRANCH_NAME"
          else
            echo "âŒ Branch $BRANCH_NAME not found. Run Phases 1-3 first."
            exit 1
          fi

      # â”€â”€ VERIFY README EXISTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # The README from Phase 3 is the input for slide generation
      - name: Verify README exists
        run: |
          TOPIC="${{ steps.extract.outputs.topic }}"
          if [ ! -f "tech-talks/${TOPIC}/README.md" ]; then
            echo "âŒ tech-talks/${TOPIC}/README.md not found. Run Phase 3 first."
            exit 1
          fi
          echo "âœ… README found on branch ${{ steps.branch.outputs.branch_name }}"

      # â”€â”€ STATUS COMMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Let the user know slide generation has started
      - name: Comment - Starting Slides
        uses: actions/github-script@v7
        with:
          script: |
            const body = [
              '## ðŸŽ¬ Phase 4 of 4: Slide Generation Started',
              '',
              'Generating Slidev slides from README on branch `${{ steps.branch.outputs.branch_name }}`...',
              '',
              '### Workflow Progress',
              '| Phase | Status | Trigger |',
              '|-------|--------|---------|',
              '| ~~1. Research~~ | âœ… Complete | â€” |',
              '| ~~2. Plan~~ | âœ… Complete | â€” |',
              '| ~~3. Build~~ | âœ… Complete | â€” |',
              '| **4. Slides** | ðŸ”„ In Progress | â€” |',
              '',
              '> ðŸ‘¤ **No action needed** â€” slides will be pushed to the PR when complete.',
            ].join('\n');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });

      # â”€â”€ COPILOT CLI: SLIDE GENERATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Builds a prompt from:
      #   - The slides template (with placeholders filled in)
      #   - The full README.md content
      #   - A list of available images for use in slides
      # Then runs Copilot CLI to generate the Slidev markdown
      - name: Run Copilot CLI for slide generation
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          TOPIC="${{ steps.extract.outputs.topic }}"

          # Build prompt from template
          sed -e "s|{{ISSUE_NUMBER}}|${{ github.event.issue.number }}|g" \
              -e "s|{{TOPIC}}|${TOPIC}|g" \
              -e "s|{{PRIMARY_QUESTION}}|${{ steps.extract.outputs.primary_question }}|g" \
              -e "s|{{AUDIENCE}}|${{ steps.extract.outputs.audience }}|g" \
              -e "s|{{DURATION}}|${{ steps.extract.outputs.duration }}|g" \
              -e "s|{{SECTION}}|${{ steps.extract.outputs.section }}|g" \
              .github/prompts/tech-talk/slides-instructions.md > slides_prompt.txt

          # Append the README as source content
          echo "" >> slides_prompt.txt
          echo "---" >> slides_prompt.txt
          echo "## Source README Content" >> slides_prompt.txt
          cat "tech-talks/${TOPIC}/README.md" >> slides_prompt.txt

          # List available images
          echo "" >> slides_prompt.txt
          echo "## Available Images" >> slides_prompt.txt
          ls "tech-talks/${TOPIC}/images/" 2>/dev/null | grep -v '.gitkeep' >> slides_prompt.txt || echo "(none)" >> slides_prompt.txt

          # Run Copilot CLI
          copilot -p @slides_prompt.txt > "slides/tech-talks/${TOPIC}.md"

          echo "âœ… Slide generation complete"

      # â”€â”€ COMMIT & PUSH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Push slides to the same feature branch (adds to existing PR)
      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          TOPIC="${{ steps.extract.outputs.topic }}"
          git add "slides/tech-talks/${TOPIC}.md"

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Phase 4: Slides for ${TOPIC} (Issue #${{ github.event.issue.number }})"
            git push origin "${{ steps.branch.outputs.branch_name }}"
          fi

      # â”€â”€ UPDATE LABELS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Mark the issue as fully complete ("tech-talk:complete")
      - name: Update labels
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['tech-talk:complete']
            });

      # â”€â”€ COMPLETION COMMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Post the final summary showing all 4 phases complete with links
      # to every artifact. Tells user to review + merge the PR.
      - name: Post completion status
        uses: actions/github-script@v7
        with:
          script: |
            const topic = '${{ steps.extract.outputs.topic }}';
            const branch = '${{ steps.branch.outputs.branch_name }}';
            const body = [
              '## ðŸŽ‰ Phase 4 of 4: Slides Complete â€” All Phases Done!',
              '',
              '### Workflow Progress',
              '| Phase | Status | Artifact |',
              '|-------|--------|----------|',
              `| ~~1. Research~~ | âœ… Complete | \`tech-talks/${topic}/research.md\` |`,
              `| ~~2. Plan~~ | âœ… Complete | \`tech-talks/${topic}/plan.md\` |`,
              `| ~~3. Build~~ | âœ… Complete | \`tech-talks/${topic}/README.md\` |`,
              `| ~~4. Slides~~ | âœ… Complete | \`slides/tech-talks/${topic}.md\` |`,
              '',
              '### Generated Slides',
              `ðŸŽ¬ [\`slides/tech-talks/${topic}.md\`](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/${branch}/slides/tech-talks/${topic}.md)`,
              '',
              `Pushed to branch \`${branch}\` and included in the PR.`,
              '',
              '---',
              '',
              '### ðŸ‘¤ Final Steps',
              '1. **Review the PR** â€” all content and slides are ready',
              '2. **Merge when satisfied** â€” the talk will be live after merge',
              '3. **Deploy slides** â€” merge triggers the slide deployment workflow',
              '',
              '> âœ… **All automated phases are complete.** This issue will close when the PR is merged.',
            ].join('\n');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });
