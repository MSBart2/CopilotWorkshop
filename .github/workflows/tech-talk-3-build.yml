# ============================================================================
# TECH TALK PIPELINE â€” PHASE 3: BUILD
# ============================================================================
#
# WHAT THIS DOES:
#   Generates the final tech talk README.md from research + plan + examples.
#   Also creates a Pull Request for review.
#
# WHEN IT RUNS:
#   When a user comments "/approve-plan" on the tech talk issue.
#   This is the only phase that requires an explicit human trigger.
#
# WHAT IT PRODUCES:
#   tech-talks/{topic}/README.md â€” The complete, publish-ready tech talk
#   A Pull Request on GitHub for review
#
# WHAT HAPPENS NEXT:
#   A comment is posted asking the user to review the PR.
#   When ready for slides, the user adds the "tech-talk:slides" label.
#
# RELATED FILES:
#   Prompt template: .github/prompts/tech-talk/build-instructions.md
#   Structure ref:   tech-talks/TEMPLATE.md (appended to prompt automatically)
#   Phase 2:         .github/workflows/tech-talk-2-plan.yml
#   Phase 4:         .github/workflows/tech-talk-4-slides.yml
# ============================================================================

name: "Tech Talk Phase 3: Build"

# Triggers when a comment is posted on any issue.
# The "if:" guard below filters for the /approve-plan command.
on:
  issue_comment:
    types: [created]

jobs:
  build:
    name: Generate Tech Talk Content
    runs-on: ubuntu-latest

    # Three conditions must ALL be true:
    #   1. This is an issue (not a PR) â€” pull_request is null for issues
    #   2. The comment contains "/approve-plan"
    #   3. The issue has the "tech-talk" label
    if: |
      github.event.issue.pull_request == null &&
      contains(github.event.comment.body, '/approve-plan') &&
      contains(github.event.issue.labels.*.name, 'tech-talk')

    permissions:
      issues: write # Post comments
      contents: write # Push commits
      pull-requests: write # Create the Pull Request

    steps:
      # â”€â”€ SETUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history needed to find the feature branch

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install GitHub Copilot CLI
        run: npm install -g @github/copilot

      # â”€â”€ EXTRACT ISSUE DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Extract issue fields
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || '';

            const extractField = (label) => {
              const regex = new RegExp(`### ${label}\\s*\\n\\s*([^#]+)`, 'i');
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            };

            core.setOutput('topic', extractField('Tech Talk Topic'));
            core.setOutput('primary_question', extractField('Primary Question') || 'Not specified');
            core.setOutput('audience', extractField('Target Audience') || 'Mixed Audience');
            core.setOutput('section', extractField('Index Section') || 'Context & Customization');
            core.setOutput('duration', extractField('Expected Duration') || '45 minutes');
            core.setOutput('guidance', extractField('Guidance \\(optional\\)') || 'No specific guidance provided');

      # â”€â”€ CHECKOUT FEATURE BRANCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout feature branch
        id: branch # Outputs: steps.branch.outputs.branch_name
        run: |
          TOPIC="${{ steps.extract.outputs.topic }}"
          BRANCH_NAME="tech-talk/${TOPIC}-${{ github.event.issue.number }}"

          if git ls-remote --exit-code origin "$BRANCH_NAME" > /dev/null 2>&1; then
            git checkout "$BRANCH_NAME"
            echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
            echo "âœ… Checked out branch: $BRANCH_NAME"
          else
            echo "âŒ Branch $BRANCH_NAME not found. Run Phases 1 & 2 first."
            exit 1
          fi

      # â”€â”€ VERIFY PREREQUISITES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Both research.md and plan.md must exist before we can build
      - name: Verify artifacts exist
        run: |
          TOPIC="${{ steps.extract.outputs.topic }}"
          for file in research.md plan.md; do
            if [ ! -f "tech-talks/${TOPIC}/${file}" ]; then
              echo "âŒ ${file} not found. Run earlier phases first."
              exit 1
            fi
          done
          echo "âœ… All required artifacts found"

      # â”€â”€ STATUS COMMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Acknowledge the /approve-plan comment and show progress
      - name: Acknowledge approval
        uses: actions/github-script@v7
        with:
          script: |
            const body = [
              '## ğŸ”¨ Phase 3 of 4: Build Started',
              '',
              'âœ… Plan approved by @${{ github.event.comment.user.login }}',
              '',
              'Generating full tech talk README from research + plan on branch `${{ steps.branch.outputs.branch_name }}`...',
              '',
              '### Workflow Progress',
              '| Phase | Status | Trigger |',
              '|-------|--------|---------|',
              '| ~~1. Research~~ | âœ… Complete | â€” |',
              '| ~~2. Plan~~ | âœ… Complete | â€” |',
              '| **3. Build** | ğŸ”„ In Progress | â€” |',
              '| 4. Slides | â³ Pending | `tech-talk:slides` label |',
              '',
              '> ğŸ‘¤ **No action needed** â€” a PR will be created when the build completes.',
            ].join('\n');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });

      # â”€â”€ COPILOT CLI: BUILD README â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # This is the main AI step. Builds a comprehensive prompt by combining:
      #   - The build instructions template (with placeholders filled in)
      #   - TEMPLATE.md (the canonical structure to follow)
      #   - research.md (source data)
      #   - plan.md (content outline)
      #   - Available images and code examples
      # Then runs Copilot CLI to generate the final README.md (500+ lines)
      - name: Run Copilot CLI for content generation
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          TOPIC="${{ steps.extract.outputs.topic }}"
          TODAY_DATE=$(date +%Y-%m-%d)

          # Build prompt from template
          sed -e "s|{{ISSUE_NUMBER}}|${{ github.event.issue.number }}|g" \
              -e "s|{{TOPIC}}|${TOPIC}|g" \
              -e "s|{{PRIMARY_QUESTION}}|${{ steps.extract.outputs.primary_question }}|g" \
              -e "s|{{AUDIENCE}}|${{ steps.extract.outputs.audience }}|g" \
              -e "s|{{DURATION}}|${{ steps.extract.outputs.duration }}|g" \
              -e "s|{{GUIDANCE}}|${{ steps.extract.outputs.guidance }}|g" \
              -e "s|{{SECTION}}|${{ steps.extract.outputs.section }}|g" \
              -e "s|{{TODAY_DATE}}|${TODAY_DATE}|g" \
              .github/prompts/tech-talk/build-instructions.md > build_prompt.txt

          # Append TEMPLATE.md as the canonical README structure
          echo "" >> build_prompt.txt
          echo "---" >> build_prompt.txt
          echo "## Target README Structure (TEMPLATE.md)" >> build_prompt.txt
          echo "" >> build_prompt.txt
          echo "Your output MUST follow this exact structure section-by-section:" >> build_prompt.txt
          echo "" >> build_prompt.txt
          cat tech-talks/TEMPLATE.md >> build_prompt.txt

          # Append all artifacts so Copilot CLI has full context
          echo "" >> build_prompt.txt
          echo "---" >> build_prompt.txt
          echo "## Research Document" >> build_prompt.txt
          cat "tech-talks/${TOPIC}/research.md" >> build_prompt.txt
          echo "" >> build_prompt.txt
          echo "## Content Plan" >> build_prompt.txt
          cat "tech-talks/${TOPIC}/plan.md" >> build_prompt.txt
          echo "" >> build_prompt.txt

          # Include available images list
          echo "## Available Images" >> build_prompt.txt
          ls "tech-talks/${TOPIC}/images/" 2>/dev/null | grep -v '.gitkeep' >> build_prompt.txt || echo "(none)" >> build_prompt.txt
          echo "" >> build_prompt.txt

          # Include example file contents
          echo "## Available Examples" >> build_prompt.txt
          for f in tech-talks/${TOPIC}/examples/*; do
            if [ -f "$f" ] && [ "$(basename $f)" != ".gitkeep" ]; then
              echo "### File: $(basename $f)" >> build_prompt.txt
              echo '```' >> build_prompt.txt
              cat "$f" >> build_prompt.txt
              echo '```' >> build_prompt.txt
              echo "" >> build_prompt.txt
            fi
          done

          # Run Copilot CLI â€” output is the final README
          copilot -p @build_prompt.txt > "tech-talks/${TOPIC}/README.md"

          echo "âœ… Content generation complete"

      # â”€â”€ COMMIT & PUSH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          TOPIC="${{ steps.extract.outputs.topic }}"
          git add "tech-talks/${TOPIC}/"
          git commit -m "Phase 3: Tech talk README for ${TOPIC} (Issue #${{ github.event.issue.number }})"
          git push origin "${{ steps.branch.outputs.branch_name }}"

      # â”€â”€ CREATE PULL REQUEST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Open a PR from the feature branch to main for human review.
      # Uses the GitHub CLI (gh) rather than the API.
      - name: Create pull request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TOPIC="${{ steps.extract.outputs.topic }}"

          gh pr create \
            --title "Tech Talk: ${TOPIC}" \
            --body "## Tech Talk: ${TOPIC}

          Generated from issue #${{ github.event.issue.number }}.

          ### Contents
          | File | Description |
          |------|-------------|
          | \`tech-talks/${TOPIC}/README.md\` | Complete tech talk |
          | \`tech-talks/${TOPIC}/research.md\` | Research findings |
          | \`tech-talks/${TOPIC}/plan.md\` | Content plan |
          | \`tech-talks/${TOPIC}/images/\` | Visual assets |
          | \`tech-talks/${TOPIC}/examples/\` | Code examples |

          ### Next Steps
          - Review the content
          - When ready for slides, add label \`tech-talk:slides\` to issue #${{ github.event.issue.number }}

          ---
          *Generated by Tech Talk Workflow Phase 3*

          Closes #${{ github.event.issue.number }}" \
            --base main \
            --head "${{ steps.branch.outputs.branch_name }}"

      # â”€â”€ UPDATE LABELS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Swap label from "tech-talk:planned" â†’ "tech-talk:ready"
      # (Phase 4 is triggered by a different label: "tech-talk:slides")
      - name: Update issue labels
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: 'tech-talk:planned'
              });
            } catch (e) { /* ignore */ }

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['tech-talk:ready']
            });

      # â”€â”€ COMPLETION COMMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Post a summary with a link to the generated README and quality indicator.
      # Quality: ğŸŸ¢ â‰¥500 lines, ğŸŸ¡ â‰¥300, ğŸ”´ <300
      # Tells user to add "tech-talk:slides" label when ready for Phase 4.
      - name: Post completion status
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const topic = '${{ steps.extract.outputs.topic }}';
            const branch = '${{ steps.branch.outputs.branch_name }}';

            // Count README lines for quality indicator
            const readmeContent = fs.readFileSync(`tech-talks/${topic}/README.md`, 'utf8');
            const readmeLines = readmeContent.split('\n').length;
            const qualityEmoji = readmeLines >= 500 ? 'ğŸŸ¢' : readmeLines >= 300 ? 'ğŸŸ¡' : 'ğŸ”´';

            const body = [
              '## âœ… Phase 3 of 4: Build Complete',
              '',
              '### Generated Content',
              '| File | Details |',
              '|------|---------|',
              `| [\`tech-talks/${topic}/README.md\`](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/${branch}/tech-talks/${topic}/README.md) | ${readmeLines} lines ${qualityEmoji} |`,
              '',
              'A **Pull Request** has been created for review.',
              '',
              '### Workflow Progress',
              '| Phase | Status | Trigger |',
              '|-------|--------|---------|',
              '| ~~1. Research~~ | âœ… Complete | â€” |',
              '| ~~2. Plan~~ | âœ… Complete | â€” |',
              '| ~~3. Build~~ | âœ… Complete | â€” |',
              '| **4. Slides** | â³ Waiting for you | Add `tech-talk:slides` label |',
              '',
              '---',
              '',
              '### ğŸ‘¤ Action Required: Review PR & Generate Slides',
              '',
              '1. **Review the Pull Request** â€” check the generated README',
              '2. **When ready for slides**, add the `tech-talk:slides` label to this issue',
              '3. Phase 4 will generate Slidev slides automatically',
              '',
              '> âš ï¸ Slides will NOT be generated until you add the `tech-talk:slides` label to this issue.',
            ].join('\n');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });
